#!/bin/bash
set -e

BUMP="${1:-minor}"
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "master" ]]; then
  echo "Error: You can only publish from master branch";
  exit 1;
fi

if [ "$(git status --untracked-files=no --porcelain)" ]; then
  echo "Error: Working directory is not clean";
  exit 1
fi

echo "Cleaning node_modules..."
rm -rf node_modules/ && npm install

echo "Adding package lock..."
git add package-lock.json
if [ "$(git status package-lock.json --untracked-files=no --porcelain)" ]; then
  git commit -m "Update lock file"
fi

echo "Bumping $BUMP version..."
npm version $BUMP

echo "Publishing..."
npm run build
npm publish --access public

echo "Pushing new version..."
git push && git push --tags

echo "Updating Storybook..."
npm run deploy-storybook
